---
# Verify the data directory parent exists (e.g., mounted external drive)
- name: Verify data directory parent mount
  ansible.builtin.stat:
    path: "{{ minio_data_dir | dirname }}"
  register: data_parent
  failed_when: not data_parent.stat.exists
  tags: [preflight]

- name: Check if data parent is a mount point
  ansible.builtin.command:
    cmd: findmnt {{ minio_data_dir | dirname }}
  register: mount_check
  changed_when: false
  failed_when: mount_check.rc != 0
  tags: [preflight]

# Ensure the minio user can traverse to the data directory
# This is needed when using external drives mounted in user directories
- name: Ensure parent directories are traversable
  ansible.builtin.shell: |
    parent="{{ minio_data_dir | dirname }}"
    while [ "$parent" != "/" ]; do
      chmod o+rx "$parent" 2>/dev/null || true
      parent=$(dirname "$parent")
    done
  changed_when: true
  tags: [preflight]

- name: Create minio group
  ansible.builtin.group:
    name: "{{ minio_group }}"
    state: present

- name: Create minio user
  ansible.builtin.user:
    name: "{{ minio_user }}"
    group: "{{ minio_group }}"
    system: yes
    shell: /bin/false
    state: present

- name: Create minio data directory
  ansible.builtin.file:
    path: "{{ minio_data_dir }}"
    state: directory
    owner: "{{ minio_user }}"
    group: "{{ minio_group }}"
    mode: '0750'

- name: Create minio configuration directory
  ansible.builtin.file:
    path: "{{ minio_config_dir }}"
    state: directory
    owner: "{{ minio_user }}"
    group: "{{ minio_group }}"
    mode: '0750'

- name: Download MinIO binary
  ansible.builtin.get_url:
    url: "https://dl.min.io/server/minio/release/linux-amd64/archive/minio.{{ minio_version }}"
    dest: "{{ minio_server_bin }}"
    mode: '0755'
    owner: root
    group: root

- name: Download MinIO Client (mc)
  ansible.builtin.get_url:
    url: "https://dl.min.io/client/mc/release/linux-amd64/mc"
    dest: "{{ minio_client_bin }}"
    mode: '0755'
    owner: root
    group: root

- name: Install MinIO environment file
  ansible.builtin.template:
    src: minio.env.j2
    dest: "{{ minio_config_dir }}/minio.env"
    owner: "{{ minio_user }}"
    group: "{{ minio_group }}"
    mode: '0600'
  notify: restart minio

- name: Install MinIO systemd service
  ansible.builtin.template:
    src: minio.service.j2
    dest: /etc/systemd/system/minio.service
    owner: root
    group: root
    mode: '0644'
  notify: restart minio

- name: Start and enable MinIO service
  ansible.builtin.systemd:
    name: minio
    state: started
    enabled: yes
    daemon_reload: yes

- name: Wait for MinIO to be ready
  ansible.builtin.uri:
    url: "http://127.0.0.1:9000/minio/health/live"
    method: GET
    status_code: 200
  register: health_check
  retries: 10
  delay: 3
  until: health_check.status == 200

- name: Configure mc alias for local MinIO
  ansible.builtin.command:
    cmd: >
      {{ minio_client_bin }} alias set local
      http://127.0.0.1:9000
      {{ minio_root_user }}
      {{ minio_root_password }}
  changed_when: true
  no_log: true

- name: Create backup buckets
  ansible.builtin.command:
    cmd: "{{ minio_client_bin }} mb --ignore-existing local/{{ item }}"
  loop:
    - etcd-backups
    - velero-backups
    - loki-chunks
    - grafana-backups
  changed_when: true

